<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:e5ui="http://efive.ru/uitemplates"
	xmlns:e5ui-comp="http://efive.ru/uitemplates/composite">

<ui:composition template="#{sessionManagement.templateName}">
	
	<ui:define name="running_head">
		<!-- #{bloodComponent.document.id}  -->
		<e5ui-comp:userSessionUpdate interval="300" />
		<h:outputScript library="js" name="datepicker_init_ru.js" target="head" />
		<h:outputScript name="jsf.js" library="javax.faces" target="head"/>
		<h:outputScript library="js" name="forms.js" target="head" />
		<e5ui-comp:outputUtilScript />
		<h:outputScript>
			var oldtValOnClick;
			var actions;
			var isVisibleHistory = false;
			
			function changeVisibleHistory() {
				if (isVisibleHistory) {
					isVisibleHistory = false;
				} else {
					isVisibleHistory = true;
				}
				hideShowHistory();
			}
			
			function hideShowHistory() {
				var blockHistory = $("[id*='history']");
				if (isVisibleHistory) {
					blockHistory.show();
				} else {
					blockHistory.hide();
				}
			}
			
			function setCursor(typeCursor) {
				var styleTitle = "cursor: " + typeCursor + ";color: #4581c0";
				$("[id*='history']").prev().find("a").attr("style", styleTitle);
			}
		
			function checkBloodComponent() {
				var componentType = $("[id='main_content_form:componentType']");
				if (componentType.val() != " ") {
					actions.attr("onclick", oldtValOnClick);
					actions.click();
				} else {
					alert("Необходимо выбрать компонент крови!");
				}
			}
			
			jQuery(function(){
				hideShowHistory();
				actions = $("[id='main_content_form:showActions']");
				oldtValOnClick = actions.attr("onclick");
				actions.attr("onclick", "checkBloodComponent()");
				if ($("[id*='purchasedComponent']").size() > 0) {
					$("[id*='purchasedComponent']").attr("checked", "true");
				}
			});
		</h:outputScript>
	</ui:define>
	
	<ui:define name="left_menu"></ui:define>
	
	<ui:define name="header">
		<div id="form_header">
			<div class="actionbar">
				<div class="menu">
					<h:panelGroup rendered="#{bloodComponent.document.statusId lt 10 or sessionManagement.admin or ((bloodComponent.document.statusId eq 100) and (sessionManagement.loggedUser.id eq bloodComponent.document.author.id))}">
					<div class="defbutton">
						<h:commandLink action="#{bloodComponent.edit}" rendered="#{bloodComponent.viewState}">
							<h:graphicImage value="#{resource['images:edit_buttn.png']}" />
							Редактировать
						</h:commandLink>
					</div>
					<div class="defbutton">
						<h:commandLink action="#{bloodComponent.cancel}" rendered="#{bloodComponent.editState or bloodComponent.createState}">
							<h:graphicImage value="#{resource['images:button-cancel.png']}" />
							Отменить
						</h:commandLink>
					</div>
					<div class="defbutton">
						<h:commandLink action="#{bloodComponent.save}" rendered="#{bloodComponent.editState or bloodComponent.createState}">
							<h:graphicImage value="#{resource['images:save_buttn.png']}" />
							Сохранить
						</h:commandLink>
					</div>
						<div class="defbutton">
							<e5ui:formPart id="actions_fp">
								<h:commandLink id="showActions" onclick="actionsModal.clickOpen('actionsModal'); return false;">
									<h:graphicImage value="#{resource['images:button-do.png']}" />
									Действия
								</h:commandLink>
								<e5ui-comp:modalWindow id="actionsModal"
											modalWindowHolder="#{bloodComponent.processorModal}"
											render=":main_content_form" execute="selectedAction"
											showButtons="false"
											widgetVar="actionsModal">
									<h:panelGroup rendered="#{not(bloodComponent.processorModal.processingState)}">
										<div id="title">Действия</div>
									</h:panelGroup>
									<h:panelGroup rendered="#{bloodComponent.processorModal.actionsAvailable}">
										<div class="wrap" style="height:90px;background-color:#fff;clear:both;">
											<div class="inner" style="height: 90px;">
												<e5ui:dataTable id="action_select_table" border="0"
															cellpadding="0" cellspacing="0"
															value="#{bloodComponent.processorModal.availableActions}" var="row"
															grouping="false" width="100%">
													<e5ui:row onclick="e5ui_util.clickElement(this, 'selectLink$');"
																styleClass="#{bloodComponent.processorModal.selected(row)? 'grid_row_selected': ''}" />
													<e5ui:column>
														<f:facet name="header">
															<p>Доступные действия</p>
														</f:facet>
														<h:outputText value="#{row.name}" />
														<h:commandLink id="selectLink" style="display: none;"
																	rendered="#{not bloodComponent.processorModal.selected(row)}"
																	action="#{bloodComponent.processorModal.select(row)}" />
													</e5ui:column>
												</e5ui:dataTable>
											</div>
										</div>
									</h:panelGroup>
									<h:panelGroup rendered="#{bloodComponent.processorModal.noActionsAvailable or bloodComponent.processorModal.failureState or bloodComponent.processorModal.processedState}">
										<div style="padding-left: 10px;">
										<ui:repeat value="#{bloodComponent.processorModal.actionResult.split(':')}" var="element">
											<h:outputText value="#{element}" /><br />
										</ui:repeat>
									</div>
									</h:panelGroup>
									<h:panelGroup rendered="#{bloodComponent.processorModal.processingState}">
										<e5ui:include data="#{bloodComponent.processorModal.processedActivity.document.form}"/>
									</h:panelGroup>
									<div class="e5ui-modal-bottombuttons">
										<h:commandButton action="#{bloodComponent.processorModal.process()}"
													rendered="#{(bloodComponent.processorModal.actionsAvailable or bloodComponent.processorModal.processingState) and not(bloodComponent.virusinaktivation)}"
													value="Выполнить" />
										<h:commandButton rendered="#{bloodComponent.virusinaktivation}"
													onclick="actionsModal.clickClose(); virusinaktivationModal.clickOpen('virusinaktivationModal'); return false;"
													value="Выполнить" />
										<h:button rendered="#{bloodComponent.processorModal.actionsAvailable or bloodComponent.processorModal.processingState}"
													onclick="actionsModal.clickClose(); return false;"
													value="Отмена" />
										<h:button rendered="#{bloodComponent.processorModal.noActionsAvailable or bloodComponent.processorModal.failureState or bloodComponent.processorModal.processedState}"
													onclick="actionsModal.clickClose(); return false;"
													value="Закрыть" />
									</div>
								</e5ui-comp:modalWindow>
								
								<e5ui-comp:modalWindow id="virusinaktivationModal"
											modalWindowHolder="#{bloodComponent.virusinaktivationModal}"
											showButtons="false"
											widgetVar="virusinaktivationModal">
									<h:panelGroup>
										<div id="title">Вирусинактивация</div>
									</h:panelGroup>
									<h:panelGroup>
										<div class="wrap" style="height:90px;background-color:#fff;clear:both;">
											<div class="inner" style="height: 90px;">
												<table style="padding:7px; height:100%; text-align:left;" border="0"  width="100%" >														
													<tr>
														<td>Объем до вирусинактивации, мл:</td>
														<td><h:outputText value="#{bloodComponent.document.volume}" style="font-weight:bold;" label="volume"/></td>
													</tr>
													<tr>
														<td>Объем компонента, мл:</td>
														<td>
															<h:inputText id="status" value="#{bloodComponent.virusinaktivationModal.volume}" 
																maxlength="9" style="font-weight:bold;">
																<f:ajax event="keyup" />
															</h:inputText>
														</td>
													</tr>
												</table>		
											</div>
										</div>
									</h:panelGroup>
									<div class="e5ui-modal-bottombuttons">
										<h:commandButton type="submit" action="#{bloodComponent.virusinaktivationModal.perfomVirusinaktivation}" value="Выполнить" />
										<h:button onclick="virusinaktivationModal.clickClose(); actionsModal.clickClose(); return false;" value="Отмена" />
									</div>
								</e5ui-comp:modalWindow>
							</e5ui:formPart>
						</div>
					<h:panelGroup rendered="#{bloodComponent.document.statusId eq 3}">
					<div class="defbutton">
						<h:panelGroup>
							<h:commandLink onclick="splitModal.clickOpen('splitModal'); return false;">
								<h:graphicImage value="#{resource['images:divide.png']}" />
								Разделить компонент
							</h:commandLink>
							<e5ui-comp:modalWindow id="splitModal"
										modalWindowHolder="#{bloodComponent.splitModal}"
										render=":main_content_form" execute="volume_list"
										style="width:300px;" showButtons="false"
										widgetVar="splitModal">
								<div id="title">Разделение компонента</div>
								<div id="modal_container" style="margin-top: 0;">
									<div class="row" style="margin:10px 5px;">
										<table class="form_grid">
											<tr class="row">
												<td class="first"><strong>Исходный объем компонента:</strong></td>
												<td>
													<h:outputText value="#{bloodComponent.document.volume}" style="font-weight:bold;margin-right:2px;" />
													<h:outputText value="мл" style="font-weight:bold;" />
												</td>
											</tr>
										</table>
									</div>
									<h:panelGroup rendered="#{bloodComponent.splitModal.invalid}">
										<div class="row" style="margin:10px 5px;">
											<h:outputText value="#{bloodComponent.splitModal.message}" style="font-weight:bold;color:red;" />
										</div>
									</h:panelGroup>
									<div class="actionbar">
										<div class="menu">
											<div class="defbutton">
												<h:commandLink action="#{bloodComponent.splitModal.addVolumeEntry()}">
													<h:graphicImage value="#{resource['images:plus.png']}" />
													<f:ajax render="volume_list" execute="volume_list" />
													Добавить
												</h:commandLink>
											</div>
										</div>
									</div>
									<div class="wrap" style="width:100%; margin:0px">
										<div class="inner">
											<e5ui:dataTable border="0" cellpadding="0" cellspacing="0"
														id="volume_list" style="width:100%;"
														value="#{bloodComponent.splitModal.volumeList}" var="row">
												<e5ui:column>
													<f:facet name="header">
														<p>Разделить на</p>
													</f:facet>
													<h:inputText value="#{row.volume}" immediate="true">
														<f:ajax />
													</h:inputText>
												</e5ui:column>
											</e5ui:dataTable>
										</div>
									</div>
								</div>
								<div class="e5ui-modal-bottombuttons">
									<h:commandButton action="#{bloodComponent.splitModal.validateAndCompose()}" value="Выполнить" />
									<h:button onclick="splitModal.clickClose(); return false;" value="Отмена" />
								</div>
							</e5ui-comp:modalWindow>
						</h:panelGroup>
					</div>
					</h:panelGroup>
					
					<h:panelGroup rendered="#{bloodComponent.document.statusId ne 1}">
					<div class="top">
                    	<h:commandLink styleClass="top_link" onclick="return false;">
                    		<span>
								<h:graphicImage value="#{resource['images:button-print.png']}" />
								Печать
							</span>
						</h:commandLink>
						<div class="sub">
					        <div class="item">
						       <h:commandLink action='#{bloodComponent.previewBigLabel()}'>
							        <h:graphicImage value="#{resource['images:blank.png']}" />
							        Этикетка компонента
						        </h:commandLink>
					        </div>
                        </div>
                    </div>
                    </h:panelGroup>
					</h:panelGroup>
				</div>
			</div>
		</div>
	</ui:define>
	
	<ui:define name="content">
		<div id="header_content">
			<h:panelGroup rendered="#{bloodComponent.createState}">
				<div class="name">Новый компонент крови</div>
			</h:panelGroup>
			<h:panelGroup rendered="#{bloodComponent.editState or bloodComponent.viewState}">
				<div class="name">
					<div>
						<span>Компонент крови</span>
						<h:outputText style="margin:0 5px;" value="#{bloodComponent.document.fullNumber}" />
						<h:outputText value="#{bloodComponent.document.created}">
							<f:convertDateTime type="date" pattern="dd.MM.yyyy"/>
						</h:outputText>
						<h:panelGroup rendered="#{bloodComponent.document.split}">
							<br />
							<span>Получено путем разделения из компонента объемом</span>
							<h:outputText style="margin:0 5px;" value="#{bloodComponent.document.splitVolume}" />
							<h:outputText value="#{bloodComponent.document.splitDate}">
								<f:convertDateTime type="date" pattern="dd.MM.yyyy"/>
							</h:outputText>
						</h:panelGroup>
						<h:panelGroup rendered="#{bloodComponent.document.purchased}">
							<br />
							<span>Закупленный компонент</span>
						</h:panelGroup>
					</div>
				</div>
				<div class="title">
					<div><h:outputText value="#{bloodComponent.document.statusName}" /></div>
				</div>
			</h:panelGroup>
			<h:panelGroup rendered="#{bloodComponent.notFoundState}">
				<div class="name">404 - Компонент не найден</div>
			</h:panelGroup>
			<h:panelGroup rendered="#{bloodComponent.forbiddenState}">
				<div class="name">403 - Действие запрещено</div>
			</h:panelGroup>
			<h:panelGroup rendered="#{not(bloodComponent.createState or bloodComponent.editState or bloodComponent.viewState or bloodComponent.notFoundState or bloodComponent.forbiddenState)}">
				<div class="name">В доступе отказано</div>
			</h:panelGroup>
		</div>
		
		<div class="main_content" style="clear: both; overflow: inherit;">
			<div class="#{bloodComponent.inControl? 'tileleft': ''}">
				<fieldset>
					<h:panelGroup rendered="#{not(bloodComponent.document.componentType.lite)}">
						<h:panelGroup rendered="#{bloodComponent.donor eq null}">
							<div style="margin-top: 10px;">
								<h:selectBooleanCheckbox value="#{bloodComponent.document.purchased}" id="purchasedComponent" disabled="true" />
								<h:outputText value="Закупленный компонент" />
							</div>
						</h:panelGroup>
						<h:panelGroup rendered="#{bloodComponent.personificationAvailable}">
							<div style="margin-top: 10px;">
								<h:selectBooleanCheckbox value="#{bloodComponent.document.personal}" disabled="#{bloodComponent.viewState or not (bloodComponent.expeditionEditAvailable)}">
									<f:ajax event="click" render="main_content_form" execute="main_content_form" />
								</h:selectBooleanCheckbox>
								<h:outputText value="Персонифицированный КК" />
							</div>
						</h:panelGroup>
						<div style="margin-top: 10px;">
							<h:selectBooleanCheckbox value="#{bloodComponent.document.inControl}" disabled="true" />
							<h:outputText value="На контроле" />
						</div>
					</h:panelGroup>
					<legend>
						<label><span class="title">Общая информация</span></label>
					</legend>
					<h:panelGroup rendered="#{bloodComponent.viewState or not (bloodComponent.expeditionEditAvailable)}">
						<div class="row">
							<table class="form_grid">
								<h:panelGroup rendered="#{bloodComponent.document.purchased and not (bloodComponent.document.componentType.lite)}">
									<tr class="row">
										<td class="first">Код донора</td>
										<td><h:outputText value="#{bloodComponent.document.donorCode}" /></td>
									</tr>
									<tr class="row">
										<td class="first">Номер накладной</td>
										<td><h:outputText value="#{bloodComponent.document.invoiceNumber}" /></td>
									</tr>
								</h:panelGroup>
								<h:panelGroup rendered="#{bloodComponent.donor ne null}">
									<tr class="row">
										<td class="first">Донор:</td>
										<td>
											<h:outputText value="#{bloodComponent.donor.description}" class="wide" />
											<h:outputLink style="margin-left:5px;" value="#{contextPath}/component/donor.xhtml" target="_blank">
												<h:graphicImage value="#{resource['images:link.png']}" />
								            	<f:param name="docId" value="#{bloodComponent.donor.id}" />
								           	</h:outputLink>
										</td>
									</tr>
								</h:panelGroup>
								<h:panelGroup rendered="#{bloodComponent.donation ne null}">
									<tr class="row">
										<td class="first">Обращение на донацию:</td>
										<td>
											<h:outputText value="#{bloodComponent.donation.number}" class="wide" />
											<h:outputLink style="margin-left:5px;" value="#{contextPath}/component/blood_donation.xhtml" target="_blank">
												<h:graphicImage value="#{resource['images:link.png']}" />
								            	<f:param name="docId" value="#{bloodComponent.donation.id}" />
								           	</h:outputLink>
										</td>
									</tr>
								</h:panelGroup>
								<tr class="row">
									<td class="first">Изготовитель:</td>
									<td>
										<h:outputText value="#{bloodComponent.document.maker.fullName}" class="wide" />
										<h:outputLink rendered="#{bloodComponent.document.maker ne null}" style="margin-left:5px;" value="#{contextPath}/component/contragent.xhtml" target="_blank">
											<h:graphicImage value="#{resource['images:link.png']}" />
								            <f:param name="docId" value="#{bloodComponent.document.maker.id}" />
								        </h:outputLink>
									</td>
								</tr>
								<h:panelGroup rendered="#{bloodComponent.personificationAvailable and bloodComponent.document.personal}">
									<tr class="row">
										<td class="first">ФИО реципиента:</td>
										<td><h:outputText value="#{bloodComponent.document.recipient}" class="wide" /></td>
									</tr>
								</h:panelGroup>
								<tr class="row">
									<td class="first">Группа крови:</td>
									<td><h:outputText value="#{bloodComponent.document.bloodGroup.value}" class="wide" /></td>
								</tr>
								<tr class="row">
									<td class="first">Резус-принадлежность:</td>
									<td><h:outputText value="#{bloodComponent.document.rhesusFactor}" converter="ClassifierConverter" /></td>
								</tr>
								<tr class="row">
									<td class="first">Дата донации:</td>
									<td>
										<h:outputText value="#{bloodComponent.document.donationDate}" class="wide">
											<f:convertDateTime type="date" pattern="dd.MM.yyyy"/>
										</h:outputText>
									</td>
								</tr>
								<h:panelGroup rendered="#{not(bloodComponent.document.componentType.lite)}">
									<tr class="row">
										<td class="first">Дата производства:</td>
										<td>
											<h:outputText value="#{bloodComponent.document.productionDate}" class="wide">
												<f:convertDateTime type="date" pattern="dd.MM.yyyy"/>
											</h:outputText>
										</td>
									</tr>
									<h:panelGroup rendered="#{bloodComponent.document.purchased}">
										<tr class="row">
											<td class="first">Дата поступления:</td>
											<td>
												<h:outputText value="#{bloodComponent.document.receivedDate}" class="wide">
													<f:convertDateTime type="date" pattern="dd.MM.yyyy"/>
												</h:outputText>
											</td>
										</tr>
									</h:panelGroup>
									<tr class="row">
										<td class="first">Дата окончания срока хранения:</td>
										<td>
											<h:outputText value="#{bloodComponent.document.expirationDate}" class="wide">
												<f:convertDateTime type="date" pattern="dd.MM.yyyy"/>
											</h:outputText>
										</td>
									</tr>
									<tr class="row">
										<td class="first">Антикоагулянт:</td>
										<td>
											<h:outputText value="#{bloodComponent.document.anticoagulant.value}" />
											<span style="margin:0 5px;">Объем, мл:</span>
											<h:outputText value="#{bloodComponent.document.anticoagulantVolume}" />
										</td>
									</tr>
								</h:panelGroup>
								<tr class="row">
									<td class="first">Компонент:</td>
									<td><h:outputText value="#{bloodComponent.document.componentType}" converter="BloodComponentTypeConverter" class="wide" style="font-weight:bold;" /></td>
								</tr>
								<h:panelGroup rendered="#{bloodComponent.erComponent}">
									<tr class="row">
										<td class="first">Вес ЭМ до фильтрации:</td>
										<td><h:outputText value="#{bloodComponent.document.emVolume}" /></td>
									</tr>
								</h:panelGroup>
								<h:panelGroup rendered="#{bloodComponent.document.inactivated}">
									<tr class="row">
										<td class="first">Объем до вирусинактивации, мл:</td>
										<td>
											<h:panelGroup rendered="#{bloodComponent.viewState}">
												<h:outputText value="#{bloodComponent.document.preInactivatedVolume}" style="font-weight:bold;" />
											</h:panelGroup>
											<h:panelGroup rendered="#{bloodComponent.editState}">
												<h:inputText value="#{bloodComponent.document.preInactivatedVolume}" style="font-weight:bold;" />
											</h:panelGroup>
										</td>
									</tr>
								</h:panelGroup>
								<tr class="row">
									<td class="first">Объем компонента, мл:</td>
									<td>
										<h:panelGroup rendered="#{bloodComponent.viewState}">
											<h:outputText value="#{bloodComponent.document.volume}" style="font-weight:bold;" />
										</h:panelGroup>
										<h:panelGroup rendered="#{bloodComponent.editState}">
											<h:inputText value="#{bloodComponent.document.volume}" style="font-weight:bold;" />
										</h:panelGroup>
									</td>
								</tr>
								<h:panelGroup rendered="#{not(bloodComponent.document.componentType.lite)}">
									<h:panelGroup rendered="#{not(bloodComponent.leukoConcentrate)}">
										<tr class="row">
											<td class="first">Количество донорских доз:</td>
											<td>
												<h:panelGroup rendered="#{bloodComponent.viewState}">
													<h:outputText value="#{bloodComponent.document.doseCount}" />
												</h:panelGroup>
												<h:panelGroup rendered="#{bloodComponent.editState}">
													<h:inputText value="#{bloodComponent.document.doseCount}" />
												</h:panelGroup>
											</td>
										</tr>
									</h:panelGroup>
									<tr class="row">
										<td class="first">Количество клеток (х10<span style="vertical-align:super;font-size:11px;"><h:outputText value="#{bloodComponent.leukoConcentrate? '9': '11'}" /></span>):</td>
										<td><h:outputText value="#{bloodComponent.document.cellCount}" /></td>
									</tr>
									<h:panelGroup rendered="#{bloodComponent.leukoConcentrate}">
										<tr class="row">
											<td class="first">Доза на кг массы тела (х10<span style="vertical-align:super;font-size:11px;">8</span>/кг)</td>
											<td><h:outputText value="#{bloodComponent.document.dosePerKg}" /></td>
										</tr>
									</h:panelGroup>
									<h:panelGroup rendered="#{not (bloodComponent.rectification)}">
										<tr class="row">
											<td class="first" colspan="2">
												<fieldset>
													<legend>
														<label><span class="title">Обработка</span> </label>
													</legend>
													<div>
														<h:selectBooleanCheckbox value="#{bloodComponent.document.inactivated}" disabled="true">
															<f:ajax event="click" listener="#{bloodComponent.inactivatedListener}" render="main_content_form" execute="main_content_form" />
														</h:selectBooleanCheckbox>
														<h:outputText value="Вирусинактивация" />
													</div>
													<div style="margin-top: 10px;">
														<h:selectBooleanCheckbox value="#{bloodComponent.document.irradiated}" disabled="#{bloodComponent.viewState}" />
														<h:outputText value="Облучение" />
													</div>
													<h:panelGroup rendered="#{not(bloodComponent.leukoConcentrate)}">
														<div style="margin-top: 10px;">
															<h:selectBooleanCheckbox value="#{bloodComponent.document.leukoFiltered}" disabled="#{bloodComponent.viewState}" />
															<h:outputText value="Лейкофильтрация" />
														</div>
													</h:panelGroup>
													<div style="margin-top: 10px;">
														<h:selectBooleanCheckbox value="#{bloodComponent.document.pooling}" disabled="#{bloodComponent.viewState}" />
														<h:outputText value="Пулирование" />
													</div>
													<div style="margin-top: 10px;">
														<h:selectBooleanCheckbox value="#{bloodComponent.document.washing}" disabled="#{bloodComponent.viewState}" />
														<h:outputText value="Отмывание" />
													</div>
												</fieldset>
											</td>
										</tr>
									</h:panelGroup>
									<tr class="row">
										<td class="first">Температура хранения:</td>
										<td>
											<span >от</span> <h:outputText style="margin:0 5px;" value="#{bloodComponent.document.lowerStorageTemperature}" />
											<span>до</span> <h:outputText style="margin:0 5px;" value="#{bloodComponent.document.higherStorageTemperature}" />
										</td>
									</tr>
									<tr class="row">
										<td class="first"><h:outputText value="#{bloodComponent.leukoConcentrate? 'Седиментирующий раствор:': 'Ресуспендирующий раствор:'}" /></td>
										<td>
											<h:outputText value="#{bloodComponent.document.preservative}" converter="ClassifierConverter" />
											<span style="margin:0 5px;">Объем, мл:</span>
											<h:outputText value="#{bloodComponent.document.preservativeVolume}" />
										</td>
									</tr>
								</h:panelGroup>
							</table>
						</div>
					</h:panelGroup>
					<h:panelGroup rendered="#{(bloodComponent.createState or bloodComponent.editState) and bloodComponent.expeditionEditAvailable}">
						<div class="row">
							<table class="form_grid">
								<h:panelGroup rendered="#{bloodComponent.document.purchased and not (bloodComponent.document.componentType.lite)}">
									<h:panelGroup rendered="#{bloodComponent.document.parentNumber ne null}">
										<tr class="row">
											<td class="first">Номер донации</td>
											<td><h:inputText value="#{bloodComponent.document.parentNumber}" /></td>
										</tr>
									</h:panelGroup>
									<tr class="row">
										<td class="first">Номер компонента</td>
										<td><h:inputText value="#{bloodComponent.document.number}" /></td>
									</tr>
									<tr class="row">
										<td class="first">Код донора</td>
										<td><h:inputText value="#{bloodComponent.document.donorCode}" /></td>
									</tr>
									<tr class="row">
										<td class="first">Номер накладной</td>
										<td><h:inputText value="#{bloodComponent.document.invoiceNumber}" /></td>
									</tr>
								</h:panelGroup>
								<h:panelGroup rendered="#{bloodComponent.donor ne null}">
									<tr class="row">
										<td class="first">Донор:</td>
										<td>
											<h:outputText value="#{bloodComponent.donor.description}" class="wide" />
											<h:outputLink style="margin-left:5px;" value="#{contextPath}/component/donor.xhtml" target="_blank">
												<h:graphicImage value="#{resource['images:link.png']}" />
								            	<f:param name="docId" value="#{bloodComponent.donor.id}" />
								           	</h:outputLink>
										</td>
									</tr>
								</h:panelGroup>
								<h:panelGroup rendered="#{bloodComponent.donation ne null}">
									<tr class="row">
										<td class="first">Обращение на донацию:</td>
										<td>
											<h:outputText value="#{bloodComponent.donation.number}" class="wide" />
											<h:outputLink style="margin-left:5px;" value="#{contextPath}/component/blood_donation.xhtml" target="_blank">
												<h:graphicImage value="#{resource['images:link.png']}" />
								            	<f:param name="docId" value="#{bloodComponent.donation.id}" />
								           	</h:outputLink>
										</td>
									</tr>
								</h:panelGroup>
								<h:panelGroup rendered="#{bloodComponent.donor ne null}">
									<td class="first">Изготовитель:</td>
									<td>
										<h:outputText value="#{bloodComponent.document.maker.fullName}" class="wide" />
										<h:outputLink rendered="#{bloodComponent.document.maker ne null}" style="margin-left:5px;" value="#{contextPath}/component/contragent.xhtml" target="_blank">
											<h:graphicImage value="#{resource['images:link.png']}" />
								            <f:param name="docId" value="#{bloodComponent.document.maker.id}" />
								        </h:outputLink>
									</td>
								</h:panelGroup>
								<h:panelGroup rendered="#{bloodComponent.donor eq null}">
									<tr class="row">
										<td class="first">
											<h:outputLink onclick="contragentSelectVar.clickOpen('contragentSelectModal'); return false;">
												Изготовитель:
											</h:outputLink>
										</td>
										<td>
											<h:panelGroup id="maker_info">
												<h:inputHidden id="globalMaker" value="#{propertiesRedactorBean.selectedProperties.extendedProperties['reports.institution.name'].objectValue}"/>
												<h:outputText id="maker" value="#{bloodComponent.document.maker.fullName}" 
											 	class="wide" />
												<h:outputLink rendered="#{bloodComponent.document.maker ne null}" style="margin-left:5px;" value="#{contextPath}/component/contragent.xhtml" target="_blank">
													<h:graphicImage value="#{resource['images:link.png']}" />
									            	<f:param name="docId" value="#{bloodComponent.document.maker.id}" />
									        	</h:outputLink>
								        	</h:panelGroup>
											<e5ui-comp:modalWindow id="contragentSelectModal"
													modalWindowHolder="#{bloodComponent.contragentSelectModal}"
													render=":main_content_form:maker_info"
													execute="contragent_select_table"
													showButtons="false"
													style="width:500px;"
													widgetVar="contragentSelectVar">
												<h:outputScript>
													jQuery(function(){
														var globalMaker = $("[id*='globalMaker']").val();
														$("[id*='contragent_select_table'] tbody td").each(function() {
															if ($(this).text() == globalMaker) {
																$(this).parent().hide();
															}
														});
													});
												</h:outputScript>
												<div id="title">Выбор изготовителя</div>
													<div id="modal_container" style="margin-top: 0;">
														<div class="searchbar">
														<h:inputText id="filter_string" value="#{bloodComponent.contragentSelectModal.contragentList.filter}" 
																style="display:block; float:left; margin-right:10px;" title="Поиск" />
														<h:commandButton value=" " action="#{bloodComponent.contragentSelectModal.contragentList.changePageOffset(0)}"
																styleClass="searchbutton">
															<f:ajax execute=":main_content_form:contragentSelectModal:filter_string"
																	render=":main_content_form:contragentSelectModal:contragent_select_table :main_content_form:contragentSelectModal:contragent_paging" />
														</h:commandButton>
													</div>
													<div class="wrap" style="height:300px;">
														<div class="inner" style="height:300px;">
															<e5ui:dataTable id="contragent_select_table" border="0" cellpadding="0" cellspacing="0"
																	value="#{bloodComponent.contragentSelectModal.contragentList.documents}"
																	var="row" grouping="false" width="100%">
																<e5ui:row onclick="e5ui_util.clickElement(this, 'selectLink$');"
																		styleClass="#{bloodComponent.contragentSelectModal.selected(row)? 'grid_row_selected': ''}" />
																<e5ui:column>
																	<f:facet name="header">
				                        								<p>Контрагент</p>
				                    								</f:facet>
				                                                	<h:outputText value="#{row.fullName}" />
				                                                	<h:commandLink id="selectLink" style="display: none;"
				                                                			rendered="#{not bloodComponent.contragentSelectModal.selected(row)}"
				                                                     		action="#{bloodComponent.contragentSelectModal.select(row)}"/>
																</e5ui:column>
															</e5ui:dataTable>
														</div>
													</div>
													<div style="clear:both;">
														<h:panelGroup id="contragent_paging">
															<e5ui-comp:tablePager id="pager" documentListHolder="#{bloodComponent.contragentSelectModal.contragentList}" />
		                                            	</h:panelGroup>
		                                       	 </div>
		                                    	</div>
		                                    	<div class="e5ui-modal-bottombuttons">
													<h:button onclick="contragentSelectVar.clickSave(); return false;" value="Выбрать" />
													<h:button onclick="contragentSelectVar.clickClose(); return false;" value="Отмена" />
												</div>
											</e5ui-comp:modalWindow>
										</td>
									</tr>
								</h:panelGroup>
								<h:panelGroup rendered="#{bloodComponent.personificationAvailable and bloodComponent.document.personal}">
									<tr class="row">
										<td class="first">ФИО реципиента:</td>
										<td><h:inputText value="#{bloodComponent.document.recipient}" class="wide" /></td>
									</tr>
								</h:panelGroup>
								<tr class="row">
									<td class="first">Группа крови:</td>
									<td>
										<h:selectOneMenu id="bloodGroup" value="#{bloodComponent.document.bloodGroup}" converter="BloodGroupConverter">
											<f:selectItems value="#{dictionaryManagement.bloodGroups}" />
										</h:selectOneMenu>
									</td>
								</tr>
								<tr class="row">
									<td class="first">Резус-принадлежность:</td>
									<td>
										<h:selectOneMenu id="rhesusFactor" value="#{bloodComponent.document.rhesusFactor}" converter="ClassifierConverter">
											<f:selectItems value="#{dictionaryManagement.getByCategory('Резус-фактор')}" />
										</h:selectOneMenu>
									</td>
								</tr>
								<tr class="row">
									<td class="first">Дата донации:</td>
									<td>
										<h:panelGroup rendered="#{bloodComponent.document.purchased}">
											<e5ui-comp:inputDate id="donationDate" value="#{bloodComponent.document.donationDate}" lang="ru" />
										</h:panelGroup>
										<h:panelGroup rendered="#{not (bloodComponent.document.purchased)}">
											<h:outputText value="#{bloodComponent.document.donationDate}" class="wide">
												<f:convertDateTime type="date" pattern="dd.MM.yyyy"/>
											</h:outputText>
										</h:panelGroup>
									</td>
								</tr>
								<h:panelGroup rendered="#{not(bloodComponent.document.componentType.lite)}">
									<tr class="row">
										<td class="first">Дата производства:</td>
										<td>
											<e5ui-comp:inputDate id="productionDate" value="#{bloodComponent.document.productionDate}" lang="ru" />
										</td>
									</tr>
									<h:panelGroup rendered="#{bloodComponent.document.purchased}">
										<tr class="row">
											<td class="first">Дата поступления:</td>
											<td>
												<e5ui-comp:inputDate id="receivedDate" value="#{bloodComponent.document.receivedDate}" lang="ru" />
											</td>
										</tr>
									</h:panelGroup>
									<tr class="row">
										<td class="first">Дата окончания срока хранения:</td>
										<td>
											<e5ui-comp:inputDate id="expirationDate" value="#{bloodComponent.document.expirationDate}" lang="ru" />
											<h:panelGroup rendered="#{bloodComponent.createState}">
												<span style="margin:0 5px 0 10px;">Количество дней:</span>
												<h:inputText value="#{bloodComponent.expirationDays}" size="4" />
											</h:panelGroup>
										</td>
									</tr>
									<tr class="row">
										<td class="first">Антикоагулянт:</td>
										<td>
											<h:selectOneMenu id="anticoagulant" value="#{bloodComponent.document.anticoagulant}" converter="AnticoagulantConverter">
												<f:selectItems value="#{dictionaryManagement.anticoagulants}" />
											</h:selectOneMenu>
											<span style="margin:0 5px;">Объем, мл:</span>
											<h:inputText value="#{bloodComponent.document.anticoagulantVolume}" />
										</td>
									</tr>
								</h:panelGroup>
								<tr class="row">
									<td class="first">Компонент:</td>
									<td>
										<h:outputScript>
											function setComponentType() {
												var listVal = $("[id*='componentTypeList']").val();
												$("[id*='componentType']").val(listVal);
											}

											jQuery(function(){
												var componentType = $("[id*='componentType']").val();
												$("[id*='componentTypeList']").val(componentType);
											});
										</h:outputScript>
										<h:inputHidden id="componentType" value="#{bloodComponent.document.componentType}" converter="BloodComponentTypeConverter" />
										<h:selectOneMenu id="componentTypeList"  onchange="setComponentType()" converter="BloodComponentTypeConverter" style="font-weight:bold;">
											<f:selectItems value="#{dictionaryManagement.usedBloodComponentTypesWithEmpty}" />
											<f:ajax listener="#{bloodComponent.componentTypeListener}" execute="main_content_form" render="main_content_form" />
										</h:selectOneMenu>
									</td>
								</tr>
								<h:panelGroup id="er_volume" rendered="#{bloodComponent.erComponent}">
									<tr class="row">
										<td class="first">Вес ЭМ до фильтрации:</td>
										<td><h:inputText value="#{bloodComponent.document.emVolume}" /></td>
									</tr>
								</h:panelGroup>
								<h:panelGroup rendered="#{bloodComponent.document.inactivated}">
									<tr class="row">
										<td class="first">Объем до вирусинактивации, мл:</td>
										<td><h:inputText value="#{bloodComponent.document.preInactivatedVolume}" style="font-weight:bold;" /></td>
									</tr>
								</h:panelGroup>
								<tr class="row">
									<td class="first">Объем компонента, мл:</td>
									<td><h:inputText value="#{bloodComponent.document.volume}" style="font-weight:bold;" /></td>
								</tr>
								<h:panelGroup rendered="#{not(bloodComponent.document.componentType.lite)}">
									<h:panelGroup rendered="#{not(bloodComponent.leukoConcentrate)}">
										<tr class="row">
											<td class="first">Количество донорских доз:</td>
											<td><h:inputText value="#{bloodComponent.document.doseCount}" /></td>
										</tr>
									</h:panelGroup>
									<tr class="row">
										<td class="first">Количество клеток (х10<span style="vertical-align:super;font-size:11px;"><h:outputText value="#{bloodComponent.leukoConcentrate? '9': '11'}" /></span>):</td>
										<td><h:inputText value="#{bloodComponent.document.cellCount}" /></td>
									</tr>
									<h:panelGroup rendered="#{bloodComponent.leukoConcentrate}">
										<tr class="row">
											<td class="first">Доза на кг массы тела (х10<span style="vertical-align:super;font-size:11px;">8</span>/кг)</td>
											<td><h:inputText value="#{bloodComponent.document.dosePerKg}" /></td>
										</tr>
									</h:panelGroup>
									<h:panelGroup rendered="#{not (bloodComponent.rectification)}">
										<tr class="row">
											<td class="first" colspan="2">
												<fieldset>
													<legend>
														<label><span class="title">Обработка</span> </label>
													</legend>
													<div>
														<h:selectBooleanCheckbox value="#{bloodComponent.document.inactivated}" disabled="true">
															<f:ajax event="click" listener="#{bloodComponent.inactivatedListener}" render="main_content_form" execute="main_content_form" />
														</h:selectBooleanCheckbox>
														<h:outputText value="Вирусинактивация" />
													</div>
													<div style="margin-top: 10px;">
														<h:selectBooleanCheckbox value="#{bloodComponent.document.irradiated}" disabled="#{bloodComponent.viewState}" />
														<h:outputText value="Облучение" />
													</div>
													<h:panelGroup rendered="#{not(bloodComponent.leukoConcentrate)}">
														<div style="margin-top: 10px;">
															<h:selectBooleanCheckbox value="#{bloodComponent.document.leukoFiltered}" disabled="#{bloodComponent.viewState}" />
															<h:outputText value="Лейкофильтрация" />
														</div>
													</h:panelGroup>
													<div style="margin-top: 10px;">
														<h:selectBooleanCheckbox value="#{bloodComponent.document.pooling}" disabled="#{bloodComponent.viewState}" />
														<h:outputText value="Пулирование" />
													</div>
													<div style="margin-top: 10px;">
														<h:selectBooleanCheckbox value="#{bloodComponent.document.washing}" disabled="#{bloodComponent.viewState}" />
														<h:outputText value="Отмывание" />
													</div>
												</fieldset>
											</td>
										</tr>
									</h:panelGroup>
									<tr class="row">
										<td class="first">Температура хранения:</td>
										<td>
											<span>от</span> <h:inputText value="#{bloodComponent.document.lowerStorageTemperature}" />
											<span>до</span> <h:inputText value="#{bloodComponent.document.higherStorageTemperature}" />
										</td>
									</tr>
									<tr class="row">
										<td class="first"><h:outputText value="#{bloodComponent.leukoConcentrate? 'Седиментирующий раствор:': 'Ресуспендирующий раствор:'}" /></td>
										<td>
											<h:selectOneMenu id="preservative" value="#{bloodComponent.document.preservative}" converter="ClassifierConverter">
												<f:selectItems value="#{dictionaryManagement.getByCategory(bloodComponent.leukoConcentrate? 'Седиментирующий раствор': 'Ресуспендирующий раствор')}" />
											</h:selectOneMenu>
											<span style="margin:0 5px;">Объем, мл:</span>
											<h:inputText value="#{bloodComponent.document.preservativeVolume}" />
										</td>
									</tr>
								</h:panelGroup>
							</table>
						</div>
					</h:panelGroup>
				</fieldset>
			</div>
			<div class="#{bloodComponent.inControl? 'tileright': ''}">
				<div>
					<h:panelGroup rendered="#{bloodComponent.inControl}">
						<fieldset>
							<legend>
								<label><span class="title">Показатели контроля качества</span> </label>
							</legend>
							<div class="wrap">
								<div class="inner">
									<e5ui:dataTable border="0" cellpadding="0" cellspacing="0"
												value="#{bloodComponent.document.appointment.tests}"
												style="width:100%;" var="row" grouping="false">
										<e5ui:column style="width:220px;">
											<f:facet name="header">
												<p>Показатель</p>
											</f:facet>
											<h:outputText value="#{row.type.value}" />
										</e5ui:column>
										<e5ui:column>
											<f:facet name="header">
												<p>Результат</p>
											</f:facet>
											<h:panelGroup rendered="#{bloodComponent.editState and bloodComponent.document.inControl}">
												<h:panelGroup rendered="#{row.type.fieldType eq 0}">
													<h:inputText class="wide" value="#{row.value}" />
												</h:panelGroup>
												<h:panelGroup rendered="#{row.type.fieldType eq 1}">
												    <h:selectOneMenu value="#{row.value}">
														<f:selectItems value="#{dictionaryManagement.getValuesByCategory(row.type.value)}" />
													</h:selectOneMenu>
												</h:panelGroup>
												<h:panelGroup rendered="#{row.type.fieldType eq 2}">
													<h:selectOneRadio layout="lineDirection" value="#{row.value}">
														<f:selectItems value="#{dictionaryManagement.getValuesByCategory(row.type.value)}" />
													</h:selectOneRadio>
												</h:panelGroup>
											</h:panelGroup>
											<h:panelGroup rendered="#{bloodComponent.viewState or not (bloodComponent.document.inControl)}">
												<h:outputText value="#{row.value}" class="wide" />
											</h:panelGroup>
										</e5ui:column>
									</e5ui:dataTable>
								</div>
							</div>
						</fieldset>
					</h:panelGroup>
				</div>
				<div>
					<fieldset>
						<legend>
							<a onmouseout="setCursor('default')" onmouseover="setCursor('pointer')" 
							onclick="changeVisibleHistory();" style="color: #4581c0">История</a> 
						</legend>
						<div id="history" class="wrap" style="width: 100%; margin: 0px">
							<div class="inner">
								<e5ui:dataTable border="0" cellpadding="0" cellspacing="0"
											id="history_list"
											value="#{bloodComponent.document.historyList}"
											var="row" grouping="false">
									<e5ui:column style="min-width:7em">
					            		<f:facet name="header">
					                        <p>Дата</p>
					                    </f:facet>
					                	<h:outputText value="#{row.startDate}">
					                		<f:convertDateTime type="date" pattern="dd.MM.yyyy HH:mm"/>
					                	</h:outputText>
					                </e5ui:column>
					                <e5ui:column style="min-width:8em">
					            		<f:facet name="header">
					                        <p>Статус</p>
					                    </f:facet>
					                	<h:outputText value="#{row.fromStatusName}" />
					                </e5ui:column>
					                <e5ui:column style="min-width:8em">
					            		<f:facet name="header">
					                        <p>Действие</p>
					                    </f:facet>
					                	<h:outputText value="#{row.actionName}" />
					                </e5ui:column>
					                <e5ui:column style="min-width:12em">
					            		<f:facet name="header">
					                        <p>Автор</p>
					                    </f:facet>
					                	<h:outputText value="#{row.owner.descriptionShort}" />
					                </e5ui:column>
					                <e5ui:column style="min-width:10em">
					            		<f:facet name="header">
					                        <p>Комментарий</p>
					                    </f:facet>
					                	<h:outputText value="#{row.commentary}" />
					                </e5ui:column>
								</e5ui:dataTable>
							</div>
						</div>
					</fieldset>
				</div>
			</div>
		</div>
	</ui:define>
	
	<ui:define name="footer">
		<e5ui-comp:splashScreen id="splash_screen" timeout="0">
	        <f:facet name="timeoutPanel">
	        	<div style="background-color: white; border-top: solid 1px black; border-bottom: solid 1px black; padding: 30px; text-align: center; margin: 200px auto; width: 300px;">
	        		Пожалуйста, подождите...
	        	</div>
	        </f:facet>
	    </e5ui-comp:splashScreen>
	    <script>e5ui_splashScreen.startShowOnSubmit('splash_screen', ['main_content_form']);</script>
	    
	    <e5ui:multiMarker id="main_form_marker" rendered="true" hintWindowStyleClass="e5ui-marker-hintWindow"
        			hintWindowInfoStyleClass="e5ui-marker-hintWindow-info" hintWindowWarnStyleClass="e5ui-marker-hintWindow-warn"
        			hintWindowErrorStyleClass="e5ui-marker-hintWindow-error" hintWindowFatalStyleClass="e5ui-marker-hintWindow-fatal" displayMode="window">
        	<h:button onclick="e5ui_multiMarker.remove('main_form_marker'); return false;" value="ОК" />
        </e5ui:multiMarker>
	    
	    <h:outputStylesheet library="css" name="datatable.css" />
		<h:outputStylesheet library="css" name="modalWindow.css" />
	    <h:outputStylesheet library="css" name="multiMarker.css" />
	    
	    <e5ui-comp:ajaxStatusGlobal timeout="300">
			<f:facet name="waitPanel">
				<div style="background-color: white; border-top: solid 1px black; border-bottom: solid 1px black; padding: 30px; text-align: center; margin: 200px auto; width: 300px;">
					Пожалуйста, подождите...</div>
			</f:facet>
		</e5ui-comp:ajaxStatusGlobal>
	</ui:define>
	
</ui:composition>
</html>