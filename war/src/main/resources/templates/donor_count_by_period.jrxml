<?xml version="1.0" encoding="UTF-8"?>
<!-- Created with Jaspersoft Studio version 6.1.0.final using JasperReports Library version 6.1.0  -->
<!-- 2015-06-09T14:33:57 -->
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="donor_count_by_period" pageWidth="595" pageHeight="842" columnWidth="555" leftMargin="20" rightMargin="20" topMargin="20" bottomMargin="20" uuid="e99d0eb9-a533-4fb2-b40a-6832340bfba9">
	<property name="com.jaspersoft.studio.data.defaultdataadapter" value="NEW_DATAADAPTER.xml"/>
	<parameter name="startDate" class="java.util.Date"/>
	<parameter name="endDate" class="java.util.Date"/>
	<queryString>
		<![CDATA[SELECT 
donor.id AS 'donorId',
 if(count(DISTINCT req.id ) = 1, 'первичный', 'повторный' ) AS 'donorType'
FROM
  trfu_blood_donation_requests req
INNER JOIN trfu_donors donor
ON donor.id = req.donor_id 
WHERE 
NOT donor.deleted
AND 
NOT req.deleted
AND 
DATE(req.created) BETWEEN DATE($P{startDate}) AND DATE($P{endDate})
GROUP BY
  donor.id
ORDER BY
  donor.id ASC]]>
	</queryString>
	<field name="donorId" class="java.lang.String"/>
	<field name="donorType" class="java.lang.String"/>
	<variable name="totalCount" class="java.lang.Integer" calculation="Count">
		<variableExpression><![CDATA[$F{donorId} != null ? 0: 1]]></variableExpression>
	</variable>
	<variable name="totalPrimary" class="java.lang.Integer" calculation="Sum">
		<variableExpression><![CDATA["Первичный".equalsIgnoreCase($F{donorType}) ? 1  : 0]]></variableExpression>
	</variable>
	<variable name="totalRepeated" class="java.lang.Integer" calculation="Sum">
		<variableExpression><![CDATA["Повторный".equalsIgnoreCase($F{donorType}) ? 1 : 0]]></variableExpression>
	</variable>
	<background>
		<band splitType="Stretch"/>
	</background>
	<title>
		<band height="44" splitType="Stretch">
			<staticText>
				<reportElement x="0" y="0" width="560" height="20" uuid="a7d91d70-b995-4341-bf6d-77762125fa1a"/>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font fontName="Tahoma" size="12"/>
				</textElement>
				<text><![CDATA[Количество доноров за период]]></text>
			</staticText>
			<textField>
				<reportElement x="0" y="20" width="560" height="20" uuid="35bec09d-a702-4a9b-911f-9419c43581ee"/>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font fontName="Tahoma" size="12"/>
				</textElement>
				<textFieldExpression><![CDATA["с "+DATEFORMAT($P{startDate}, "dd.MM.yyyy") +" по "+DATEFORMAT($P{endDate}, "dd.MM.yyyy")]]></textFieldExpression>
			</textField>
		</band>
	</title>
	<columnHeader>
		<band height="15" splitType="Stretch">
			<staticText>
				<reportElement x="30" y="0" width="150" height="15" uuid="edf4fcd4-3224-4221-a44e-d3962d5e89d7"/>
				<box>
					<topPen lineWidth="1.0"/>
					<leftPen lineWidth="1.0"/>
					<bottomPen lineWidth="1.0"/>
					<rightPen lineWidth="1.0"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font fontName="Tahoma"/>
				</textElement>
				<text><![CDATA[Идентифкатор донора]]></text>
			</staticText>
			<staticText>
				<reportElement x="180" y="0" width="150" height="15" uuid="8c84f13d-48f3-4cda-8145-f3ebbcd8c9c9"/>
				<box>
					<topPen lineWidth="1.0"/>
					<leftPen lineWidth="1.0"/>
					<bottomPen lineWidth="1.0"/>
					<rightPen lineWidth="1.0"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font fontName="Tahoma"/>
				</textElement>
				<text><![CDATA[Тип донора]]></text>
			</staticText>
		</band>
	</columnHeader>
	<detail>
		<band height="15" splitType="Stretch">
			<textField>
				<reportElement x="30" y="0" width="150" height="15" uuid="5c060428-e390-4e24-b7a0-645fd6aeaa8a"/>
				<box>
					<topPen lineWidth="1.0"/>
					<leftPen lineWidth="1.0"/>
					<bottomPen lineWidth="1.0"/>
					<rightPen lineWidth="1.0"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font fontName="Tahoma"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{donorId}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="180" y="0" width="150" height="15" uuid="1b945e39-b18a-487a-8153-61fa43a4d036"/>
				<box>
					<topPen lineWidth="1.0"/>
					<leftPen lineWidth="1.0"/>
					<bottomPen lineWidth="1.0"/>
					<rightPen lineWidth="1.0"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font fontName="Tahoma"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{donorType}]]></textFieldExpression>
			</textField>
		</band>
	</detail>
	<summary>
		<band height="20" splitType="Stretch">
			<property name="com.jaspersoft.studio.unit.height" value="pixel"/>
			<textField>
				<reportElement x="180" y="0" width="150" height="20" uuid="2701f953-96f6-405c-989a-ed5013776633">
					<property name="com.jaspersoft.studio.unit.height" value="pixel"/>
				</reportElement>
				<textElement textAlignment="Left" verticalAlignment="Middle">
					<font fontName="Tahoma" size="12"/>
				</textElement>
				<textFieldExpression><![CDATA["Первичных: "+$V{totalPrimary}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="330" y="0" width="150" height="20" uuid="ccacccd9-0929-4a96-a60e-6eebfe2c6728">
					<property name="com.jaspersoft.studio.unit.width" value="pixel"/>
					<property name="com.jaspersoft.studio.unit.height" value="pixel"/>
				</reportElement>
				<textElement textAlignment="Left" verticalAlignment="Middle">
					<font fontName="Tahoma" size="12"/>
				</textElement>
				<textFieldExpression><![CDATA["Повторных: "+$V{totalRepeated}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="30" y="0" width="150" height="20" uuid="42b05217-6951-4dad-ba0c-13933ebd9c96">
					<property name="com.jaspersoft.studio.unit.height" value="pixel"/>
				</reportElement>
				<textElement textAlignment="Left" verticalAlignment="Middle">
					<font fontName="Tahoma" size="12"/>
				</textElement>
				<textFieldExpression><![CDATA["Всего: "+$V{totalCount}]]></textFieldExpression>
			</textField>
		</band>
	</summary>
</jasperReport>
