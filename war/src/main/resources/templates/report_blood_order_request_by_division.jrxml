<?xml version="1.0" encoding="UTF-8"?>
<!-- Created with Jaspersoft Studio version 6.1.0.final using JasperReports Library version 6.1.0  -->
<!-- 2015-06-01T16:57:12 -->
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="report_blood_order_request_by_division" pageWidth="595" pageHeight="842" columnWidth="555" leftMargin="20" rightMargin="20" topMargin="20" bottomMargin="20" uuid="6ccf9fd0-ca7a-4d6d-b6f2-4658d21fa670">
	<property name="com.jaspersoft.studio.data.defaultdataadapter" value="NEW_DATAADAPTER.xml"/>
	<parameter name="StartDate" class="java.util.Date">
		<parameterDescription><![CDATA[Дата начала отчетного периода]]></parameterDescription>
	</parameter>
	<parameter name="EndDate" class="java.util.Date">
		<parameterDescription><![CDATA[Дата окончания отчетного периода]]></parameterDescription>
	</parameter>
	<queryString>
		<![CDATA[SELECT req.number AS 'requestNumber'
     , req.created AS 'requestCreatedDate'
     , req.recipient AS 'patientLastName'
     , KK_TYPE.value AS 'тип запрошенных КК'
     , group_concat(DISTINCT ifnull(OUT_KK_TYPE.value, '')) AS 'out_KK_types'
     , req.volume AS 'обем запрошенных КК'
     , sum(ifnull(KK.volume, 0)) AS 'out_KK_volumes'
     , CASE req.transfusionType
       WHEN 0 THEN
         concat('Плановая на дату ', req.planDate)
       WHEN 1 THEN
         'Экстренная'
       END AS 'Вид трансфузии'
     , req.division AS 'division'
FROM
  trfu_blood_component_order_requests req
INNER JOIN trfu_blood_component_types KK_TYPE
ON KK_TYPE.id = req.componentType_id
LEFT JOIN trfu_blood_components KK
ON KK.orderId = req.id
LEFT JOIN trfu_blood_component_types OUT_KK_TYPE
ON KK.componentType_id = OUT_KK_TYPE.id
WHERE
  req.deleted = 0
  AND
  date(req.created) BETWEEN date($P{StartDate}) AND date($P{EndDate})
GROUP BY
  req.id
ORDER BY
  division ASC, req.number DESC;]]>
	</queryString>
	<field name="requestNumber" class="java.lang.String"/>
	<field name="requestCreatedDate" class="java.sql.Timestamp"/>
	<field name="patientLastName" class="java.lang.String"/>
	<field name="out_KK_types" class="java.lang.String"/>
	<field name="out_KK_volumes" class="java.lang.Integer"/>
	<field name="division" class="java.lang.String"/>
	<variable name="divisionVolumeSum" class="java.lang.Integer" resetType="Group" resetGroup="groupByDivision" calculation="Sum">
		<variableExpression><![CDATA[$F{out_KK_volumes}]]></variableExpression>
	</variable>
	<variable name="totalVolumeSum" class="java.lang.Integer" calculation="Sum">
		<variableExpression><![CDATA[$F{out_KK_volumes}]]></variableExpression>
	</variable>
	<group name="groupByDivision" isStartNewPage="true">
		<groupExpression><![CDATA[$F{division}]]></groupExpression>
		<groupHeader>
			<band height="21">
				<textField>
					<reportElement mode="Opaque" x="-11" y="0" width="571" height="21" backcolor="#D6D2D2" uuid="ae121ab6-da67-4f17-9c87-0ea30a60cd40"/>
					<textElement textAlignment="Center" verticalAlignment="Middle">
						<font fontName="Tahoma"/>
					</textElement>
					<textFieldExpression><![CDATA[$F{division}]]></textFieldExpression>
				</textField>
			</band>
		</groupHeader>
		<groupFooter>
			<band height="20">
				<staticText>
					<reportElement x="-11" y="0" width="271" height="20" uuid="19f7bb66-dfcc-4f1e-9918-9f5b3b141e88"/>
					<box>
						<topPen lineWidth="1.0"/>
						<leftPen lineWidth="1.0"/>
						<bottomPen lineWidth="1.0"/>
						<rightPen lineWidth="1.0"/>
					</box>
					<textElement textAlignment="Center" verticalAlignment="Middle">
						<font fontName="Tahoma"/>
					</textElement>
					<text><![CDATA[Итого выдано мл по отделению]]></text>
				</staticText>
				<textField>
					<reportElement x="260" y="0" width="300" height="20" uuid="d8eb7b4e-efae-4e92-a2a2-1c702c62b9c5"/>
					<box>
						<topPen lineWidth="1.0"/>
						<leftPen lineWidth="1.0"/>
						<bottomPen lineWidth="1.0"/>
						<rightPen lineWidth="1.0"/>
					</box>
					<textElement textAlignment="Center" verticalAlignment="Middle">
						<font fontName="Tahoma"/>
					</textElement>
					<textFieldExpression><![CDATA[$V{divisionVolumeSum}]]></textFieldExpression>
				</textField>
			</band>
		</groupFooter>
	</group>
	<background>
		<band splitType="Stretch"/>
	</background>
	<title>
		<band height="40" splitType="Stretch">
			<property name="com.jaspersoft.studio.unit.height" value="pixel"/>
			<staticText>
				<reportElement x="-20" y="0" width="595" height="20" uuid="1511a075-5189-465d-9118-dddc678e8986"/>
				<textElement textAlignment="Center">
					<font fontName="Tahoma" size="12"/>
				</textElement>
				<text><![CDATA[Отчет "Выданные компоненты по заявкам отделений"]]></text>
			</staticText>
			<textField>
				<reportElement x="-20" y="20" width="595" height="20" uuid="2eb79ecc-7d43-4842-80c3-e08a7ca20714"/>
				<textElement textAlignment="Center">
					<font fontName="Tahoma"/>
				</textElement>
				<textFieldExpression><![CDATA["За период с "+DATEFORMAT($P{StartDate}, "dd.MM.yyyy")+ " по "+DATEFORMAT($P{EndDate}, "dd.MM.yyyy")]]></textFieldExpression>
			</textField>
		</band>
	</title>
	<columnHeader>
		<band height="30" splitType="Stretch">
			<staticText>
				<reportElement x="-11" y="0" width="81" height="30" uuid="980420e9-5022-460f-832a-28900b768006"/>
				<box leftPadding="0" rightPadding="0">
					<topPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font fontName="Tahoma"/>
				</textElement>
				<text><![CDATA[№ заявки]]></text>
			</staticText>
			<staticText>
				<reportElement x="70" y="0" width="100" height="30" uuid="f5dfc905-2e50-4a4a-882c-487885c80325"/>
				<box leftPadding="0" rightPadding="0">
					<topPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font fontName="Tahoma"/>
				</textElement>
				<text><![CDATA[Дата создания заявки]]></text>
			</staticText>
			<staticText>
				<reportElement x="170" y="0" width="90" height="30" uuid="12a98405-a70b-41cf-b12c-2d4887627657"/>
				<box leftPadding="0" rightPadding="0">
					<topPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font fontName="Tahoma"/>
				</textElement>
				<text><![CDATA[Фамилия пациента]]></text>
			</staticText>
			<staticText>
				<reportElement x="260" y="0" width="210" height="30" uuid="4a6ce2e6-4d34-4796-bc8c-277b1532ef39"/>
				<box leftPadding="0" rightPadding="0">
					<topPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font fontName="Tahoma"/>
				</textElement>
				<text><![CDATA[Типы выданных КК]]></text>
			</staticText>
			<staticText>
				<reportElement x="470" y="0" width="90" height="30" uuid="897fd2f5-cc61-400b-b15a-a08a0725e2c9"/>
				<box leftPadding="0" rightPadding="0">
					<topPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font fontName="Tahoma"/>
				</textElement>
				<text><![CDATA[Суммарный объем выданных КК]]></text>
			</staticText>
		</band>
	</columnHeader>
	<detail>
		<band height="27" splitType="Stretch">
			<textField isStretchWithOverflow="true" isBlankWhenNull="false">
				<reportElement stretchType="RelativeToBandHeight" x="-11" y="0" width="81" height="27" uuid="9622f4f1-46a4-40a8-aa23-e8792858df7a"/>
				<box>
					<topPen lineWidth="1.0"/>
					<leftPen lineWidth="1.0"/>
					<bottomPen lineWidth="1.0"/>
					<rightPen lineWidth="1.0"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font fontName="Tahoma"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{requestNumber}]]></textFieldExpression>
			</textField>
			<textField isStretchWithOverflow="true">
				<reportElement stretchType="RelativeToBandHeight" x="70" y="0" width="100" height="27" uuid="fba14606-2fd2-4717-bf35-60ac1caa2429"/>
				<box>
					<topPen lineWidth="1.0"/>
					<leftPen lineWidth="1.0"/>
					<bottomPen lineWidth="1.0"/>
					<rightPen lineWidth="1.0"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font fontName="Tahoma"/>
				</textElement>
				<textFieldExpression><![CDATA[new SimpleDateFormat("dd.MM.yyyy HH:mm").format($F{requestCreatedDate})]]></textFieldExpression>
			</textField>
			<textField isStretchWithOverflow="true">
				<reportElement stretchType="RelativeToBandHeight" x="170" y="0" width="90" height="27" uuid="f5a28216-fc3f-4cb2-85b9-9bb0987add4c"/>
				<box>
					<topPen lineWidth="1.0"/>
					<leftPen lineWidth="1.0"/>
					<bottomPen lineWidth="1.0"/>
					<rightPen lineWidth="1.0"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font fontName="Tahoma"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{patientLastName}]]></textFieldExpression>
			</textField>
			<textField isStretchWithOverflow="true">
				<reportElement stretchType="RelativeToBandHeight" x="260" y="0" width="210" height="27" uuid="6ffea02a-924c-437a-a43e-9b512782ec9a"/>
				<box>
					<topPen lineWidth="1.0"/>
					<leftPen lineWidth="1.0"/>
					<bottomPen lineWidth="1.0"/>
					<rightPen lineWidth="1.0"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font fontName="Tahoma"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{out_KK_types}]]></textFieldExpression>
			</textField>
			<textField isStretchWithOverflow="true">
				<reportElement stretchType="RelativeToBandHeight" x="470" y="0" width="90" height="27" uuid="2f0e67f8-caee-4a01-aecc-9f1bf6297ebf"/>
				<box>
					<topPen lineWidth="1.0"/>
					<leftPen lineWidth="1.0"/>
					<bottomPen lineWidth="1.0"/>
					<rightPen lineWidth="1.0"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font fontName="Tahoma"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{out_KK_volumes}]]></textFieldExpression>
			</textField>
		</band>
	</detail>
	<summary>
		<band height="20">
			<staticText>
				<reportElement mode="Opaque" x="-11" y="0" width="271" height="20" backcolor="#B3B1B1" uuid="e588559e-561c-4d5f-ad5e-d9aa4b90973e"/>
				<box>
					<topPen lineWidth="1.0"/>
					<leftPen lineWidth="1.0"/>
					<bottomPen lineWidth="1.0"/>
					<rightPen lineWidth="1.0"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font fontName="Tahoma"/>
				</textElement>
				<text><![CDATA[Итого выдано мл по всем отделениям]]></text>
			</staticText>
			<textField>
				<reportElement x="260" y="0" width="300" height="20" uuid="24eb53ac-70d7-4bab-9b9e-f7924e63080f"/>
				<box>
					<topPen lineWidth="1.0"/>
					<leftPen lineWidth="1.0"/>
					<bottomPen lineWidth="1.0"/>
					<rightPen lineWidth="1.0"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font fontName="Tahoma"/>
				</textElement>
				<textFieldExpression><![CDATA[$V{totalVolumeSum}]]></textFieldExpression>
			</textField>
		</band>
	</summary>
</jasperReport>
